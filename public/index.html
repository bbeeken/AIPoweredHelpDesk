<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Powered Help Desk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
</head>
<body>

  <a href="#main" class="skip-link">Skip to content</a>

  <header class="flex justify-between items-center py-4">
    <div class="flex items-center gap-2">
      <button id="menuToggle" aria-controls="sidebar" aria-expanded="false" class="border p-2 md:hidden">â˜°</button>
      <h1 class="text-2xl font-bold">AI Powered Help Desk</h1>
    </div>
    <nav class="hidden md:block">
      <a href="/chat.html" class="text-blue-600 hover:underline mr-4">AI Chat</a>
      <a href="/realtime.html" class="text-blue-600 hover:underline">Real-Time</a>
    </nav>
    <button id="themeToggle" type="button" aria-label="Toggle dark mode" class="ml-4">ðŸŒ“</button>
  </header>

  <nav id="sidebar" aria-label="Sidebar" class="fixed inset-y-0 left-0 w-56 bg-gray-100 dark:bg-gray-900 p-4 transform -translate-x-full transition-transform md:static md:translate-x-0 md:w-48">
    <ul class="space-y-2">
      <li><a href="/index.html" class="block hover:underline">Dashboard</a></li>
      <li><a href="/chat.html" class="block hover:underline">AI Chat</a></li>
      <li><a href="/realtime.html" class="block hover:underline">Real-Time</a></li>
    </ul>
  </nav>
  <main id="main" class="mt-4">

    <section id="stats" aria-live="polite" class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Ticket Stats</h2>
      <canvas id="statusChart" class="mb-4"></canvas>
      <p id="statCounts"></p>
      <p id="statForecast"></p>
      <p id="statMttr"></p>
      <p id="assetTotal"></p>
    </section>

    <form id="searchForm" class="flex gap-2 mb-4">
      <label for="search" class="visually-hidden">Search tickets</label>
      <input id="search" type="search" placeholder="Search tickets..." list="suggestions" autocomplete="off" class="border p-2 flex-grow" />
      <datalist id="suggestions"></datalist>
      <button type="submit" class="border px-3 py-2">Search</button>
    </form>

    <div class="flex items-center gap-2 mb-2">
      <label for="statusFilter" class="visually-hidden">Status</label>
      <select id="statusFilter" class="border p-2">
        <option value="">All statuses</option>
        <option value="open">Open</option>
        <option value="waiting">Waiting</option>
        <option value="closed">Closed</option>
      </select>
    </div>

    <table id="ticketTable" class="table-auto w-full border-collapse text-sm">
      <thead>
        <tr>
          <th data-sort="id" class="border px-2 py-1 cursor-pointer">ID</th>
          <th data-sort="question" class="border px-2 py-1 cursor-pointer">Question</th>
          <th data-sort="status" class="border px-2 py-1 cursor-pointer">Status</th>
          <th data-sort="priority" class="border px-2 py-1 cursor-pointer">Priority</th>
        </tr>
      </thead>
      <tbody id="tickets"></tbody>
    </table>
  </main>
  <script>
    const tableBody = document.getElementById('tickets');
    const statusFilter = document.getElementById('statusFilter');
    let sortField = 'id';
    let sortOrder = 'asc';

    async function fetchTickets() {
      const url = new URL('/tickets', location.origin);
      if (statusFilter.value) url.searchParams.set('status', statusFilter.value);
      url.searchParams.set('sortBy', sortField);
      url.searchParams.set('order', sortOrder);
      const res = await fetch(url);
      return res.json();
    }

    function renderTickets(tickets) {
      tableBody.innerHTML = '';
      tickets.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1"><a href="/ticket.html?id=${t.id}" class="text-blue-600 hover:underline">${t.id}</a></td>
          <td class="border px-2 py-1">${t.question}</td>
          <td class="border px-2 py-1">${t.status}</td>
          <td class="border px-2 py-1">${t.priority}</td>`;
        tableBody.appendChild(tr);
      });
    }

    async function loadTickets() {
      const tickets = await fetchTickets();
      renderTickets(tickets);
    }

    document.getElementById('searchForm').onsubmit = async e => {
      e.preventDefault();
      const q = document.getElementById('search').value.trim();
      if (!q) return;
      const res = await fetch('/tickets/search?q=' + encodeURIComponent(q));
      const tickets = await res.json();
      renderTickets(tickets);
    };

    statusFilter.addEventListener('change', loadTickets);
    document.querySelectorAll('#ticketTable th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.getAttribute('data-sort');
        if (sortField === field) {
          sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortOrder = 'asc';
        }
        loadTickets();
      });
    });

    loadTickets();

    // Fetch suggestions as user types
    let suggestTimer;
    document.getElementById('search').addEventListener('input', e => {
      clearTimeout(suggestTimer);
      const q = e.target.value.trim();
      if (q.length < 2) return;
      suggestTimer = setTimeout(async () => {
        const res = await fetch('/tickets/search?q=' + encodeURIComponent(q));
        const tickets = await res.json();
        const list = document.getElementById('suggestions');
        list.innerHTML = '';
        tickets.slice(0, 5).forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.question;
          list.appendChild(opt);
        });
      }, 300);
    });

    async function loadStats() {
      try {
        const res = await fetch('/stats/dashboard');
        const stats = await res.json();
        document.getElementById('statCounts').textContent =
          `Open: ${stats.tickets.open}, Waiting: ${stats.tickets.waiting}, Closed: ${stats.tickets.closed}`;
        document.getElementById('statForecast').textContent =
          `Expected new tickets next 7 days: ${stats.forecast.toFixed(1)}`;
        document.getElementById('statMttr').textContent =
          `Average resolution time: ${stats.mttr.toFixed(1)}h`;
        document.getElementById('assetTotal').textContent =
          `Total assets: ${stats.assets.total}`;
        new Chart(
          document.getElementById('statusChart').getContext('2d'),
          {
            type: 'bar',
            data: {
              labels: ['Open', 'Waiting', 'Closed'],
              datasets: [{
                data: [stats.tickets.open, stats.tickets.waiting, stats.tickets.closed],
                backgroundColor: ['#3b82f6', '#facc15', '#10b981']
              }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
          }
        );
      } catch (err) {
        console.error('Error loading stats', err);
      }
    }

  loadStats();

  // Dark mode toggle
  const themeToggle = document.getElementById('themeToggle');
  function applyTheme(theme) {
    document.body.classList.toggle('dark', theme === 'dark');
  }
  themeToggle.addEventListener('click', () => {
    const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  });
  applyTheme(localStorage.getItem('theme') || 'light');

  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      const open = sidebar.classList.toggle('open');
      sidebar.classList.toggle('-translate-x-full', !open);
      menuToggle.setAttribute('aria-expanded', open);
    });
  }

  // Real-time ticket updates
  if (window.EventSource) {
    const es = new EventSource('/events');
    es.addEventListener('ticketCreated', loadTickets);
    es.addEventListener('ticketUpdated', loadTickets);
  }

  // Register service worker for offline support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  </script>
</body>
</html>
