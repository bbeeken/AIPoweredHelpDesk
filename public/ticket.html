<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ticket Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
</head>
<body>
  <a href="#main" class="skip-link">Skip to content</a>
  <header class="flex justify-between items-center py-4">
    <div class="flex items-center gap-2">
      <button id="menuToggle" aria-controls="sidebar" aria-expanded="false" class="border p-2 md:hidden">â˜°</button>
      <h1 class="text-2xl font-bold">Ticket Details</h1>
    </div>
    <nav class="hidden md:block">
      <a href="/index.html" class="text-blue-600 hover:underline mr-4">Home</a>
      <a href="/realtime.html" class="text-blue-600 hover:underline">Real-Time</a>
    </nav>
    <button id="themeToggle" type="button" aria-label="Toggle dark mode" class="ml-4">ðŸŒ“</button>
  </header>

  <nav id="sidebar" aria-label="Sidebar" class="fixed inset-y-0 left-0 w-56 bg-gray-100 dark:bg-gray-900 p-4 transform -translate-x-full transition-transform md:static md:translate-x-0 md:w-48">
    <ul class="space-y-2">
      <li><a href="/index.html" class="block hover:underline">Dashboard</a></li>
      <li><a href="/chat.html" class="block hover:underline">AI Chat</a></li>
      <li><a href="/realtime.html" class="block hover:underline">Real-Time</a></li>
    </ul>
  </nav>
  <main id="main" class="prose max-w-none">
    <div id="details"></div>
    <div id="articles" class="mt-4"></div>
  </main>
  <script>
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
    }
  themeToggle.addEventListener('click', () => {
    const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  });
  applyTheme(localStorage.getItem('theme') || 'light');

  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      const open = sidebar.classList.toggle('open');
      sidebar.classList.toggle('-translate-x-full', !open);
      menuToggle.setAttribute('aria-expanded', open);
    });
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    async function loadTicket() {
      if (!id) return;
      const res = await fetch('/tickets/' + id);
      if (!res.ok) return;
      const t = await res.json();
      const d = document.getElementById('details');
      d.innerHTML = `
        <h2>Ticket #${t.id}</h2>
        <p><strong>Status:</strong> ${t.status}</p>
        <p><strong>Priority:</strong> ${t.priority}</p>
        <p>${t.question}</p>
      `;

      try {
        const aiRes = await fetch('/ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: t.question })
        });
        const aiData = await aiRes.json();
        if (aiData.articles && aiData.articles.length) {
          const list = aiData.articles
            .map(a => `<li><a href="${a.url}" class="text-blue-600 hover:underline">${a.title}</a></li>`) 
            .join('');
          document.getElementById('articles').innerHTML = `<h3>Relevant Articles</h3><ul>${list}</ul>`;
        }
      } catch (err) {
        console.error('Failed to load AI results', err);
      }
    }
    loadTicket();
  </script>
</body>
</html>
