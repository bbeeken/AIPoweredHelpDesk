<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
</head>
<body>

  <a href="#main" class="skip-link">Skip to content</a>

  <header class="flex justify-between items-center py-4">
    <div class="flex items-center gap-2">
      <button id="menuToggle" aria-controls="sidebar" aria-expanded="false" class="border p-2 md:hidden">â˜°</button>
      <h1 class="text-2xl font-bold">AI Chat</h1>
    </div>
    <nav class="hidden md:block">
      <a href="/index.html" class="text-blue-600 hover:underline mr-4">Home</a>
      <a href="/realtime.html" class="text-blue-600 hover:underline">Real-Time</a>
    </nav>
    <button id="themeToggle" type="button" aria-label="Toggle dark mode" class="ml-4">ðŸŒ“</button>
  </header>

  <nav id="sidebar" aria-label="Sidebar" class="fixed inset-y-0 left-0 w-56 bg-gray-100 dark:bg-gray-900 p-4 transform -translate-x-full transition-transform md:static md:translate-x-0 md:w-48">
    <ul class="space-y-2">
      <li><a href="/index.html" class="block hover:underline">Dashboard</a></li>
      <li><a href="/chat.html" class="block hover:underline">AI Chat</a></li>
      <li><a href="/realtime.html" class="block hover:underline">Real-Time</a></li>
    </ul>
  </nav>
  <main id="main" class="mt-4">
    <div id="messages" role="log" aria-live="polite" class="border p-4 h-72 overflow-y-auto mb-4"></div>
    <form id="chatForm" class="flex gap-2">
      <label for="msg" class="visually-hidden">Message</label>
      <input id="msg" placeholder="Ask a question..." size="50" class="border flex-grow p-2" />
      <button id="voice" type="button" aria-label="Start voice input" class="border px-3">ðŸŽ¤</button>
      <button type="submit" class="border px-4">Send</button>
    </form>
    <div id="suggestions" class="mt-2 space-x-2"></div>
    <div id="assist" class="mt-2 text-sm text-gray-600"></div>
  </main>
  <script>
    const suggDiv = document.getElementById('suggestions');
    const assistDiv = document.getElementById('assist');
    if (window.EventSource) {
      const es = new EventSource('/assist');
      es.onmessage = e => {
        const tips = JSON.parse(e.data);
        assistDiv.textContent = tips.join(' | ');
      };
    }

    const msgInput = document.getElementById('msg');
    let assistTimeout;
    msgInput.addEventListener('input', () => {
      clearTimeout(assistTimeout);
      assistTimeout = setTimeout(() => {
        fetch('/assist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: msgInput.value })
        });
      }, 300);
    });
    document.getElementById('chatForm').onsubmit = async e => {
      e.preventDefault();
      const input = document.getElementById('msg');
      let text = input.value.trim();
      if(!text) return;

      if(text.startsWith('/ai')) {
        text = text.slice(3).trim();
        const res = await fetch('/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})});
        const data = await res.json();
        const options = Array.isArray(data.suggestions) ? data.suggestions : (data.reply ? [data.reply] : []);
        suggDiv.innerHTML = '';
        options.forEach(opt => {
          const b = document.createElement('button');
          b.type = 'button';
          b.textContent = opt;
          b.className = 'border px-2 py-1 mr-2 mb-2 hover:bg-gray-200';
          b.onclick = () => {
            input.value = opt;
            suggDiv.innerHTML = '';
          };
          suggDiv.appendChild(b);
        });
        if(options.length === 0) {
          suggDiv.textContent = 'No suggestions available.';
        }
        return;
      }

      const messages = document.getElementById('messages');
      const userMsg = document.createElement('div');
      userMsg.textContent = 'You: ' + text;
      messages.appendChild(userMsg);
      const res = await fetch('/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})});
      const data = await res.json();
      const botMsg = document.createElement('div');
      let reply = data.reply || JSON.stringify(data);
      if (data.translation && data.translation.original && data.translation.text) {
        reply += `\n(${data.translation.original})`;
      }
      botMsg.textContent = 'AI: ' + reply;
      messages.appendChild(botMsg);
      input.value = '';
      messages.scrollTop = messages.scrollHeight;
    };

    // Voice input using SpeechRecognition
    const voiceBtn = document.getElementById('voice');
    if (voiceBtn) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        const recognizer = new SpeechRecognition();
        recognizer.addEventListener('result', e => {
          const text = Array.from(e.results)
            .map(r => r[0].transcript)
            .join(' ');
          document.getElementById('msg').value = text;
        });
        voiceBtn.onclick = () => {
          recognizer.start();
        };
      } else {
        voiceBtn.style.display = 'none';
      }
    }

    // Dark mode toggle
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
    }
  themeToggle.addEventListener('click', () => {
    const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  });
  applyTheme(localStorage.getItem('theme') || 'light');

  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      const open = sidebar.classList.toggle('open');
      sidebar.classList.toggle('-translate-x-full', !open);
      menuToggle.setAttribute('aria-expanded', open);
    });
  }

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  </script>
</body>
</html>
